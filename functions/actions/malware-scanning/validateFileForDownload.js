const createChecksum = require('./createChecksum');
const path = require('path');

module.exports = (config, db, firebase) => {

  return {
    validateFileForDownload,
  };

  async function validateFileForDownload(fileURL) {
    const bucket = firebase.storage().bucket(config.STORAGE_URL);
    const file = bucket.file(fileURL);
    const exists = (await file.exists())[0];

    if (!exists) {
      return {
        result: 'error',
        error: 'file not found',
      };
    }

    const [metadata] = await file.getMetadata();
    if (metadata.metadata && metadata.metadata.status === 'infected') {
      return {
        result: 'error',
        error: 'file is infected',
      };
    }

    const fileName = path.basename(fileURL);

    const checksumDoc = await db.collection('checksums').doc(fileName).get();
    if (!checksumDoc.exists) {
      return {
        result: 'error',
        error: 'checksum not found',
      };
    }

    const checksumData = checksumDoc.data();
    const [fileContent] = await file.download();
    const calculatedChecksum = createChecksum(fileContent);

    if (calculatedChecksum !== checksumData.checksum) {
      return {
        result: 'error',
        error: 'checksum mismatch',
      };
    }

    return {
      result: 'success',
    };
  }
};
