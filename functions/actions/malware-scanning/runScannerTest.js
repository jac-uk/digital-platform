const { scanFile } = require('./scanFile.js');

module.exports = (config, firebase) => {

  const SCAN_SERVICE_URL = config.SCAN_SERVICE_URL;

  return {
    runScannerTest,
  };

  async function runScannerTest() {
    const eicarTestFilePath = 'virusScanner-testFiles/eicar.com.txt';
    const cleanTestFilePath = 'virusScanner-testFiles/nothing.txt';

    const eicarScanResult = await scanFile(eicarTestFilePath);
    const cleanScanResult = await scanFile(cleanTestFilePath);

    const testResults = {
      timestamp: new Date(),
      eicarScanResult,
      cleanScanResult,
    };

    const settingsRef = firebase.firestore.collection('services').doc('settings').collection('fileUpload').doc('enabled');

    // Ensure the settings document exists with a default 'enabled' value
    await settingsRef.set({ enabled: true }, { merge: true });

    // Store the test results in the logs sub-collection
    await settingsRef.collection('logs').add(testResults);

    if (eicarScanResult.status !== 'infected' || cleanScanResult.status !== 'clean') {
      // Send alert
      console.error('Automated test failed:', testResults);
      // Add your alerting mechanism here, e.g., send an email or a Slack message
    } else {
      console.log('Automated test passed:', testResults);
    }
  }
};
