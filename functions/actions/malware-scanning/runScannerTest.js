let scanFileModule = require('./scanFile.js');
let scanFile;

module.exports = (config, firebase, db) => {
  scanFile = scanFileModule(config, firebase).scanFile;

  return {
    runScannerTest,
  };

  async function runScannerTest() {
    const eicarTestFilePath = 'virusScanner-testFiles/eicar.com.txt';
    // const eicarTestFilePath = 'virusScanner-testFiles/nothing.txt';
    // const cleanTestFilePath = 'virusScanner-testFiles/eicar.com.txt';
    const cleanTestFilePath = 'virusScanner-testFiles/nothing.txt';

    const eicarScanResult = await scanFile(eicarTestFilePath);
    const cleanScanResult = await scanFile(cleanTestFilePath);

    cleanResultData = cleanScanResult.data ? cleanScanResult.data.status : cleanScanResult.result;
    eicarResultData = eicarScanResult.data ? eicarScanResult.data.status : eicarScanResult.result;

    const testResults = {
      timestamp: new Date(),
      clean: cleanResultData === 'clean',
      eicar: eicarResultData === 'error',
    };

    const servicesRef = db.collection('settings').doc('services');

    // Ensure the services document exists with a default 'enabled' value
    await servicesRef.set({
      fileUpload: {
        enabled: testResults.clean && testResults.eicar,
      },
    }, { merge: true });

    // Retrieve existing logs, append the new log entry, and update Firestore
    const doc = await servicesRef.get();
    let logs = [];

    if (doc.exists && doc.data().fileUpload && Array.isArray(doc.data().fileUpload.logs)) {
      logs = doc.data().fileUpload.logs;
    }

    logs.push(testResults);

    await servicesRef.set({
      fileUpload: {
        logs: logs,
      },
    }, { merge: true });

    if (!testResults.clean || !testResults.eicar) {
      // Send alert
      console.error('Automated test failed:', testResults);
      // Add your alerting mechanism here, e.g., send an email or a Slack message
    } else {
      console.log('Automated test passed:', testResults);
    }
    return testResults;
  }
};
