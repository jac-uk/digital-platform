module.exports = (firebase, db) => {

  const crypto = require('crypto');

  return {
    addChecksumToFirestore,
  };

  async function addChecksumToFirestore(filePath, checksum) {
    const checksumsCollection = db.collection('checksums');
    const existingDoc = await checksumsCollection.where('filePath', '==', filePath).get();

    if (!existingDoc.empty) {
      existingDoc.forEach(async doc => {
        if (doc.data().checksum !== checksum) {
          await doc.ref.update({ checksum, lastScanned: new Date() });
        }
      });
    } else {
      await checksumsCollection.add({
        filepath: filePath,
        checksum,
        created: firebase.firestore.Timestamp.fromDate(new Date()),
      });
    }
    return `${checksum} added`;
  }
};
