

# Virus Configurations and Policies Documentation

### Configuration values

#### scanAllFiles.js

 - API_MAX_REQUEST:
	 **Previous Value:** 100
	 **Updated Value:** 100
	 **Reason for Change:**
	 **Function:** After **[API_MAX_REQUEST]** files have been scanned, wait for [API_RATE_WINDOW_MS] before scanning **[API_MAX_REQUEST]** files are scanned again. Loop until all files scanned.

- API_RATE_WINDOW_MS:
	**Previous Value**: 60000
	**Updated Value:** 60000
	 **Reason for Change:**
	 **Function:** After [API_MAX_REQUEST] files have been scanned, wait for **[API_RATE_WINDOW_MS]** milliseconds before scanning [API_MAX_REQUEST] files are scanned again. Loop until all files scanned.

- UPDATE_LOG_SECOND:
	**Previous Value**: 10
	 **Updated Value:** 10
	 **Reason for Change:**
	 **Function:** As files are scanned,  results are saved to the log-file, which is updated every **[UPDATE_LOG_SECOND]** seconds to prevent hitting the write limit (once per second)

#### scheduleScanAllFiles.js

- SCHEDULE: <sup>†</sup>
	**Previous Value**: 'every 1 hours'
	 **Updated Value:** 'every 1 hours'
	 **Reason for Change:**
	 **Function:** This CRON value reflects how often this action is run.

- runtimeOptions:
	**Previous Value:** { timeoutSeconds:  540, memory:  '4GB' }
	 **Updated Value:** { timeoutSeconds:  540, memory:  '4GB' }
	 **Reason for Change:**
	 **Function:** Options for the instance created to run this action, `memory` may need adjustment to ensure it is sufficient. 540 seconds is the maximum value for `timeoutSeconds`.

### File Scanning Policy

**Description:**

Upon upload every file is scanned for viruses using [clamdjs](https://www.npmjs.com/package/clamdjs).  (`onDocumentUploaded.js`). The scan is performed by a service hosted on a docker container. Related files can be found in `digital-platform > google-app-engine`.
Scanned files have metadata added as they are processed. This metadata includes a `scanned` timestamp and a `status` flag. 

If a file **does not** have the status of  `'clean'` users will be unable to download the file, and the `DownloadLink.vue` component will present text reading "File not available" instead of a link to download the file.
This is how our frontend ensures that any unscanned files, files without a status, or files that have been marked as 'infected' **cannot** be downloaded. 

Equally within our `storage.rules` a check `isOkForDownload()` is performed to ensure that **only**  safe files can be downloaded. These rules dictate that only those files which have a `metadata` field, which is not empty and contains a status which is not `'infected'` can be downloaded. Ensuring only scanned and marked safe files are able to be accessed.

On an hourly<sup>†</sup> schedule, a storage wide file scan is performed. This scan performs the same actions as are taken for `onDocumentUploaded.js` excluding only files are part of the `virusScanningLogs` or which already have a status. 
From this check, a log-file is created and stored in `virusScanningLogs`

### Summary of Changes:

| Updated: | Author  | Changes |
|--|--|--|
| 9/05/24 | Tom Russell | Document created re: [Admin 2257](https://github.com/jac-uk/admin/issues/2257)|
