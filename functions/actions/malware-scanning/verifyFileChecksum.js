const admin = require('firebase-admin');
const createChecksum = require('./createChecksum');

module.exports = (config, firebase, db) => {

  return {
    verifyChecksum,
  };

  /**
   * Verifies the checksum of a file stored in Firebase.
   * @param {string} filePath - The path of the file in Firebase Storage.
   * @returns {Promise<object>} - An object indicating whether the checksum is valid.
   */
  async function verifyChecksum(filePath) {
    try {
      // Get expected checksum from Firestore
      const fileDoc = await db.collection('checksums').doc(filePath).get();
      if (!fileDoc.exists) {
        throw new Error('File metadata not found');
      }
      const expectedChecksum = fileDoc.data().checksum;

      // Download the file from Firebase Storage
      const bucket = firebase.storage().bucket(config.STORAGE_URL);
      const file = bucket.file(filePath);
      const [fileContent] = await file.download();

      // Calculate the current checksum
      const currentChecksum = createChecksum(fileContent);

      // Compare checksums
      if (expectedChecksum === currentChecksum) {
        return { valid: true };
      } else {
        return { valid: false, message: 'Checksum mismatch' };
      }
    } catch (error) {
      return { valid: false, message: error.message };
    }
  }
};
