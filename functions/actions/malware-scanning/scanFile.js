const request = require('request-promise');

module.exports = (config, firebase) => {
  const SCAN_SERVICE_URL = config.SCAN_SERVICE_URL;

  return {
    scanFile,
  };

  /**
   * Scans a single file for viruses.
   * @param {string} fileURL - The URL of the file to scan.
   * @returns {Promise<object>} - The result of the scan.
   */
  async function scanFile(fileURL) {
    try {
      if (fileURL.includes('virusScanningLogs') && fileURL.endsWith('.json')) {
        return {
          result: 'skip',
          error: 'virus scanning logs file',
        };
      }

      const bucket = firebase.storage().bucket(config.STORAGE_URL);
      const file = bucket.file(fileURL);
      const exists = (await file.exists())[0];

      if (!exists) {
        return {
          result: 'error',
          error: 'file not found',
        };
      }

      const options = {
        method: 'POST',
        uri: SCAN_SERVICE_URL,
        body: {
          filename: fileURL,
          projectId: config.PROJECT_ID,
        },
        json: true,
      };

      const scanResult = await request(options).catch((e) => {
        return { error: e.message };
      });

      if (scanResult.status !== 'clean') {
        return {
          result: 'error',
          error: 'File did not pass the virus scan',
        };
      }

      return scanResult;

    } catch (e) {
      console.error(`Error occurred while scanning file: ${fileURL}`, e);
      return { result: 'error', error: e.message };
    }
  }
};
