import request from 'request-promise';

export default (config, firebase) => {

  const SCAN_SERVICE_URL = config.SCAN_SERVICE_URL;

  return {
    scanFile,
  };

  /**
   * Scan the specified file for viruses
   */
  async function scanFile(fileURL) {
    try {

      // skip virus scanning logs files
      if (fileURL.includes('virusScanningLogs') && fileURL.endsWith('.json')) {
        return {
          result: 'skip',
          error: 'virus scanning logs file',
        };
      }

      const bucket = firebase.storage().bucket(config.STORAGE_URL);
      const file = bucket.file(fileURL);
      const exists = (await file.exists())[0]; // the exists() function returns an array with a single boolean element in it

      // validate input
      if (!exists) {
        return {
          result: 'error',
          error: 'file not found',
        };
      }

      // setup the HTTP request to the malware scanner web service
      const options = {
        method: 'POST',
        uri: SCAN_SERVICE_URL,
        body: {
          filename: fileURL,
          projectId: firebase.instanceId().app.options.projectId,
        },
        json: true,
      };

      // make the HTTP request
      return request(options).then((data) => {
        return data;
      }).catch((e) => {
        return {
          error: e.message,
        };
      });

    } catch (e) {
      console.error(`Error occurred while scanning file: ${fileURL}`, e);
      return false;
    }
  }

};
