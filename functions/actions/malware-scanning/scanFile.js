const functions = require('firebase-functions');
const request = require('request-promise');

module.exports = (config, firebase) => {

  const PROJECT_ID = functions.config().project.id;
  const SCAN_SERVICE_URL = `https://malware-scanner-dot-${PROJECT_ID}.appspot.com/scan`;

  return {
    scanFile,
  };

  /**
   * Scan the specified file for viruses
   */
  async function scanFile(fileURL) {
    try {
      const bucket = firebase.storage().bucket(config.STORAGE_URL);
      const file = bucket.file(fileURL);
      const exists = (await file.exists())[0]; // the exists() function returns an array with a single boolean element in it

      // validate input
      if (!exists) {
        return {
          result: 'error',
          error: 'file not found',
        };
      }

      // setup the HTTP request to the malware scanner web service
      const options = {
        method: 'POST',
        uri: SCAN_SERVICE_URL,
        body: {
          filename: fileURL,
        },
        json: true,
      };

      // make the HTTP request
      return request(options).then((data) => {
        return data;
      }).catch((e) => {
        return {
          error: e.message,
        };
      });

    } catch (e) {
      console.error(`Error occurred while scanning file: ${fileURL}`, e);
      return false;
    }
  }

};
