import axios from 'axios';

export default (config, firebase) => {
  const SCAN_SERVICE_URL = config.SCAN_SERVICE_URL;

  return scanFile;

  /**
   * Scans a single file for viruses.
   * @param {string} fileURL - The URL of the file to scan.
   * @returns {Promise<object>} - The result of the scan.
   */
  async function scanFile(fileURL) {
    console.log('scan file');
    
    try {
      if (fileURL.includes('virusScanningLogs') && fileURL.endsWith('.json')) {
        return {
          result: 'skip',
          error: 'virus scanning logs file',
        };
      }

      const bucket = firebase.storage().bucket(config.STORAGE_URL);
      const file = bucket.file(fileURL);
      const exists = (await file.exists())[0];

      if (!exists) {
        return {
          result: 'error',
          error: 'file not found',
        };
      }

      const options = {
        method: 'POST',
        url: SCAN_SERVICE_URL,
        data: {
          filename: fileURL,
          projectId: config.PROJECT_ID,
        },
        headers: {
          'Content-Type': 'application/json',
        },
      };

      const scanResult = await axios(options);

      if (scanResult.data.status !== 'clean') {
        return {
          result: 'error',
          error: 'File did not pass the virus scan',
        };
      }

      return scanResult;

      if (scanResult.data.status !== 'clean') {
        return {
          result: 'error',
          error: 'File did not pass the virus scan',
        };
      }

      return scanResult;

    } catch (e) {
      console.log(`Error occurred while scanning file: ${fileURL}`, e.message);
      return { result: 'error', error: e.message };
    }
  }
};
