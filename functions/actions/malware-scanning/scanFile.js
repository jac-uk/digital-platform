const axios = require('axios');

module.exports = (config, firebase) => {
  const SCAN_SERVICE_URL = config.SCAN_SERVICE_URL;

  return {
    scanFile,
  };

  /**
   * Scan the specified file for viruses
   */
  async function scanFile(fileURL) {
    try {
      // skip virus scanning logs files
      if (fileURL.includes('virusScanningLogs') && fileURL.endsWith('.json')) {
        return {
          result: 'skip',
          error: 'virus scanning logs file',
        };
      }

      const bucket = firebase.storage().bucket(config.STORAGE_URL);
      const file = bucket.file(fileURL);
      const exists = (await file.exists())[0];

      // validate input
      if (!exists) {
        return {
          result: 'error',
          error: 'file not found',
        };
      }

      // setup the HTTP request to the malware scanner web service
      const requestData = {
        filename: fileURL,
        projectId: firebase.instanceId().app.options.projectId,
      };

      // make the HTTP request using Axios
      const response = await axios.post(SCAN_SERVICE_URL, requestData);

      return response.data;
    } catch (error) {
      console.error(`Error occurred while scanning file: ${fileURL}`, error);
      return {
        error: error.message,
      };
    }
  }
};
