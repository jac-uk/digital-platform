import path from 'path';
import createChecksum from './createChecksum.js';
import addChecksumToFirestoreInit from './addChecksumToFirestore.js';
import scanFileInit from './scanFile.js';

export default (config, firebase, db) => {

  const scanFile = scanFileInit(config, firebase);
  const addChecksumToFirestore = addChecksumToFirestoreInit(firebase, db);

  return scanFileAndCreateChecksum;

  /**
   * Scans a single file for viruses and creates a checksum if the file is clean.
   * @param {string} fileURL - The URL of the file to scan.
   * @returns {Promise<object>} - The result of the scan and checksum operation.
   */
  
  async function scanFileAndCreateChecksum(fileURL) {
    try {
      // Scan the file
      const scanResult = await scanFile(fileURL);
      if (scanResult.data.status === 'clean') {
        // Get the bucket and file
        const bucket = firebase.storage().bucket(config.STORAGE_URL);
        const file = bucket.file(fileURL);
        const [fileContent] = await file.download();

        // Create checksum
        const checksum = createChecksum(fileContent);

        // Extract the file name from the URL
        const fileName = path.basename(fileURL);

        // Add checksum to Firestore with the file name as the document ID
        await addChecksumToFirestore(fileName, checksum);

        return {
          result: 'success',
          checksum: checksum,
        };
      }

      return scanResult;

    } catch (e) {
      console.error(`Error occurred while scanning and creating checksum for file: ${fileURL}`, e);
      return { result: 'error', error: e.message };
    }
  }
};
