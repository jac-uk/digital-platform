const { createChecksum, storeChecksum } = require('./checksumUtils');
const { scanFile } = require('./scanFile'); 

module.exports = (config, firebase) => {

  return {
    scanFileAndCreateChecksum,
  };

  /**
   * Scans a single file for viruses and creates a checksum if the file is clean.
   * @param {string} fileURL - The URL of the file to scan.
   * @returns {Promise<object>} - The result of the scan and checksum operation.
   */
  async function scanFileAndCreateChecksum(fileURL) {
    try {
      const scanResult = await scanFile(config, firebase).scanFile(fileURL);

      if (scanResult.status === 'clean') {
        const bucket = firebase.storage().bucket(config.STORAGE_URL);
        const file = bucket.file(fileURL);
        const [fileContent] = await file.download();

        const checksum = createChecksum(fileContent);

        await storeChecksum(firebase.firestore(), fileURL, path.basename(fileURL), checksum);

        return {
          result: 'success',
          checksum: checksum,
        };
      }

      return scanResult;

    } catch (e) {
      console.error(`Error occurred while scanning and creating checksum for file: ${fileURL}`, e);
      return { result: 'error', error: e.message };
    }
  }
};
